terraform-plan-analysis:
  stage: build
  image: "gcr.io/lc-interactive/terraform-plan-analyzer:latest"
  variables:
    PLAN_FILE: "tf_output.json"
    OUTPUT_FILE: "terraform_analysis.md"
    SAVE_SANITIZED: "sanitized_plan.json"
    GEMINI_MODEL: "gemini-2.0-flash-001"
    TF_DIR: "."
    SKIP_CODE: "false"
    MAX_FILES: ""
    SAVE_PROMPT: "true"
    SEND_TO_GEMINI: "true"
    GITLAB_COMMENT: "true"
  before_script:
    - echo "Starting Analysis..."
  script:
    - /app/entrypoint.sh
    - |
      # Verify output files
      echo "Checking output files:"
      ls -la
      if [ -f "$OUTPUT_FILE" ]; then
        echo "Found output file: $OUTPUT_FILE"
        cat "$OUTPUT_FILE" | head -n 20
      else
        echo "Output file not found: $OUTPUT_FILE"
        echo "No changes detected in the Terraform plan." > "$OUTPUT_FILE"
      fi
      
      if [ "$SAVE_PROMPT" = "true" ]; then
        if [ -f "prompt_output.txt" ]; then
          echo "Found prompt file: prompt_output.txt"
        else
          echo "Prompt file not found"
          echo "No prompt was generated." > prompt_output.txt
        fi
      fi
  after_script:
    - echo "Finished Analysis..."
  artifacts:
    paths:
      - terraform_analysis.md
      - prompt_output.txt
      - sanitized_plan.json
    when: always
  dependencies:
    - build plan
  needs:
    - job: build plan
      artifacts: true
      optional: false
  only:
    - merge_requests