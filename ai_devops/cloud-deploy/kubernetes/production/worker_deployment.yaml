apiVersion: apps/v1
kind: Deployment
metadata:
  name: $KUBE_NAMESPACE-worker-$CI_COMMIT_REF_SLUG
  namespace: $KUBE_NAMESPACE
  labels:
    # Standard labels - follow these patterns, additional labels can be added if needed
    app: $KUBE_NAMESPACE-worker-$CI_COMMIT_REF_SLUG    # This is our standard, do not change
    environment: $DOPPLER_ENVIRONMENT                  # This is our standard, do not change (output pulled from doppler will be either dev_,dev,stg,or prd)
    gitlab_project: $CI_PROJECT_NAME                   # This is our standard, do not change
    gitlab_pipeline_id: "$CI_PIPELINE_ID"              # This is our standard, do not change
    project_owner: web                                 # Select only from one of the following (web, api, sre, data, or rock)
    tier: backend                                      # Select only from one of the following (frontend, backend, database or job)
# Section will be project needs specific
spec:
  replicas: 5
  selector:
    matchLabels:
      app: $KUBE_NAMESPACE-worker-$CI_COMMIT_REF_SLUG    # This is our standard, do not change
      
  template:
    metadata:
      labels:
        # Standard labels - follow these patterns, additional labels can be added if needed
        app: $KUBE_NAMESPACE-worker-$CI_COMMIT_REF_SLUG    # This is our standard, do not change
        environment: $DOPPLER_ENVIRONMENT              # This is our standard, do not change, should match the labels from the deployment (output pulled from doppler will be either dev_,dev,stg,or prd)
        gitlab_project: $CI_PROJECT_NAME               # This is our standard, do not change, should match the labels from the deployment
        gitlab_pipeline_id: "$CI_PIPELINE_ID"          # This is our standard, do not change, should match the labels from the deployment
        project_owner: web                             # Select only from one of the following (web, api, sre, data, or rock), should match the labels from the deployment
        tier: backend                                  # Select only from one of the following (frontend, backend, database or job), should match the labels from the deployment
      annotations:
        build_id: "job-${CI_JOB_ID}"
    spec:
      terminationGracePeriodSeconds: 60
      containers:
      - name: $KUBE_NAMESPACE-worker-$CI_COMMIT_REF_SLUG
        image: gcr.io/${PROJECT_ID}/${CI_PROJECT_NAME}:${CI_COMMIT_SHA}-$CI_PIPELINE_ID
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 3000
        resources:
          limits:
            cpu: "1"
            memory: "512M"
        envFrom:
        - secretRef:
            name: $KUBE_NAMESPACE-secret-$CI_COMMIT_REF_SLUG
        command: ["bundle", "exec", "sidekiq"]
        args: ["-e", "production", "-q", "default", "-q", "mailers"]
